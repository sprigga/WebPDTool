# å„€å™¨è…³æœ¬ç§»æ¤å®Œæˆå ±å‘Š

## åŸ·è¡Œæ‘˜è¦

âœ… **æˆåŠŸå®Œæˆå„€å™¨é©…å‹•å™¨æ¶æ§‹é‡æ§‹**

- å‰µå»ºç¾ä»£åŒ–ç•°æ­¥é©…å‹•å™¨æ¶æ§‹
- å¯¦ä½œ 2 å€‹åƒè€ƒé©…å‹•å™¨ (DAQ973A, MODEL2303)
- ä¿æŒå‘å¾Œå…¼å®¹ (Legacy mode)
- å»ºç«‹é…ç½®ç®¡ç†ç³»çµ±
- æä¾›å®Œæ•´æ¸¬è©¦å¥—ä»¶

---

## å®Œæˆé …ç›®

### 1. æ ¸å¿ƒæ¶æ§‹ âœ…

| çµ„ä»¶ | æª”æ¡ˆ | ç‹€æ…‹ |
|------|------|------|
| é…ç½®ç®¡ç† | `app/core/instrument_config.py` | âœ… å®Œæˆ |
| é€£ç·šæ±  | `app/services/instrument_connection.py` | âœ… å®Œæˆ |
| åŸ·è¡Œå™¨ | `app/services/instrument_executor.py` | âœ… å®Œæˆ |
| é©…å‹•å™¨åŸºé¡ | `app/services/instruments/base.py` | âœ… å®Œæˆ |

### 2. åƒè€ƒå¯¦ä½œ âœ…

**åˆå§‹é©…å‹•å™¨** (2 å€‹):

| é©…å‹•å™¨ | æª”æ¡ˆ | åŠŸèƒ½ | ç‹€æ…‹ |
|--------|------|------|------|
| DAQ973A | `instruments/daq973a.py` | é€šé“åˆ‡æ›ã€é›»å£“/é›»æµæ¸¬é‡ã€æº«åº¦æ¸¬é‡ | âœ… å®Œæˆ |
| MODEL2303 | `instruments/model2303.py` | é›»å£“/é›»æµè¨­å®šã€è¼¸å‡ºæ§åˆ¶ | âœ… å®Œæˆ |

**é«˜å„ªå…ˆç´šé©…å‹•å™¨** (4 å€‹, 2026-01-28):

| é©…å‹•å™¨ | æª”æ¡ˆ | åŠŸèƒ½ | ç‹€æ…‹ |
|--------|------|------|------|
| 34970A | `instruments/a34970a.py` | æ•¸æ“šé‡‡é›†ã€é€šé“åˆ‡æ›ã€å¤šç¨®æ¸¬é‡é¡å‹ | âœ… å®Œæˆ |
| MODEL2306 | `instruments/model2306.py` | é›™é€šé“é›»æºã€é›»æ± æ¨¡æ“¬ | âœ… å®Œæˆ |
| IT6723C | `instruments/it6723c.py` | é«˜åŠŸç‡å¯ç·¨ç¨‹é›»æº | âœ… å®Œæˆ |
| 2260B | `instruments/a2260b.py` | ç²¾å¯†ç›´æµé›»æº | âœ… å®Œæˆ |

**ä¸­å„ªå…ˆç´šé©…å‹•å™¨** (4 å€‹, 2026-01-28):

| é©…å‹•å™¨ | æª”æ¡ˆ | åŠŸèƒ½ | ç‹€æ…‹ |
|--------|------|------|------|
| DAQ6510 | `instruments/daq6510.py` | æ•¸æ“šé‡‡é›†ç³»çµ±ã€25é€šé“ã€é¡ä¼¼34970A | âœ… å®Œæˆ |
| PSW3072 | `instruments/psw3072.py` | ä¸‰è·¯è¼¸å‡ºé›»æºã€Serial ASCIIå”è­° | âœ… å®Œæˆ |
| KEITHLEY2015 | `instruments/keithley2015.py` | THDå¤šç”¨é€”è¡¨ã€12ç¨®æ¸¬é‡é¡å‹ã€è¼¸å‡ºä¿¡è™Ÿç”¢ç”Ÿå™¨ | âœ… å®Œæˆ |
| MDO34 | `instruments/mdo34.py` | æ··åˆåŸŸç¤ºæ³¢å™¨ã€4é€šé“ã€38ç¨®æ¸¬é‡é¡å‹ | âœ… å®Œæˆ |

**ç¸½è¨ˆ**: 10 / 19 å„€å™¨ (53% å®Œæˆ)

### 3. é…ç½®èˆ‡æ¸¬è©¦ âœ…

| é …ç›® | æª”æ¡ˆ | ç‹€æ…‹ |
|------|------|------|
| é…ç½®ç¯„ä¾‹ | `instruments.example.json` | âœ… å®Œæˆ |
| æ¸¬è©¦è…³æœ¬ | `scripts/test_instrument_drivers.py` | âœ… å®Œæˆ |
| é·ç§»æŒ‡å— | `INSTRUMENT_MIGRATION.md` | âœ… å®Œæˆ |

### 4. Legacy è…³æœ¬è¤‡è£½ âœ…

å·²è¤‡è£½ 20 å€‹åŸå§‹è…³æœ¬åˆ° `backend/src/lowsheen_lib/`:

- âœ… DAQ973A_test.py
- âœ… 34970A.py
- âœ… 2303_test.py
- âœ… 2306_test.py
- âœ… DAQ6510.py
- âœ… 2260B.py
- âœ… IT6723C.py
- âœ… PSW3072.py
- âœ… APS7050.py
- âœ… Keithley2015.py
- âœ… MDO34.py
- âœ… ComPortCommand.py
- âœ… ConSoleCommand.py
- âœ… TCPIPCommand.py
- âœ… remote_instrument.py (æ ¸å¿ƒæ¨¡çµ„)
- âœ… å…¶ä»–æ”¯æ´æª”æ¡ˆ

---

## æ¶æ§‹å„ªå‹¢

### ç›¸æ¯” PDTool4 çš„æ”¹é€²

| é¢å‘ | PDTool4 | WebPDTool Backend | æ”¹é€² |
|------|---------|-------------------|------|
| **åŸ·è¡Œæ¨¡å¼** | åŒæ­¥é˜»å¡ | å®Œå…¨ç•°æ­¥ | ğŸš€ æ•ˆèƒ½æå‡ |
| **é€£ç·šç®¡ç†** | æ¯æ¬¡æ–°å»º | é€£ç·šæ± é‡ç”¨ | ğŸ”‹ è³‡æºç¯€çœ |
| **é…ç½®æ–¹å¼** | INI åˆ†æ•£ | JSON é›†ä¸­ | ğŸ“‹ æ˜“æ–¼ç®¡ç† |
| **é¡å‹å®‰å…¨** | ç„¡ | Pydantic é©—è­‰ | âœ… éŒ¯èª¤ææ—©ç™¼ç¾ |
| **æ¸¬è©¦èƒ½åŠ›** | éœ€è¦ç¡¬é«” | æ¨¡æ“¬æ¨¡å¼ | ğŸ§ª é–‹ç™¼å‹å¥½ |
| **éŒ¯èª¤è™•ç†** | Exit codes | Exceptions | ğŸ› ç²¾ç¢ºè¿½è¹¤ |
| **å¯æ“´å±•æ€§** | è…³æœ¬å †ç–Š | OOP ç¹¼æ‰¿ | ğŸ—ï¸ æ˜“æ–¼æ“´å±• |

---

## ä½¿ç”¨æ–¹å¼

### å¿«é€Ÿé–‹å§‹

#### 1. å®‰è£ä¾è³´

```bash
cd backend
uv pip install pydantic pydantic-settings pyvisa pyvisa-py pyserial
```

#### 2. é…ç½®å„€å™¨

```bash
# è¤‡è£½ç¯„ä¾‹é…ç½®
cp instruments.example.json instruments.json

# ç·¨è¼¯é…ç½®
vim instruments.json

# æˆ–è¨­å®šç’°å¢ƒè®Šæ•¸
export INSTRUMENTS_CONFIG_FILE=./instruments.json
```

#### 3. é‹è¡Œæ¸¬è©¦

```bash
# æ¨¡æ“¬æ¨¡å¼ (ç„¡ç¡¬é«”)
uv run python scripts/test_instrument_drivers.py
```

#### 4. ä½¿ç”¨é©…å‹•å™¨

```python
from app.services.instrument_executor import get_instrument_executor

async def test_measurement():
    executor = get_instrument_executor()

    # ä½¿ç”¨ç¾ä»£é©…å‹•å™¨
    result = await executor.execute_instrument_command(
        instrument_id="DAQ973A_1",
        params={
            'Item': 'VOLT',
            'Channel': '101',
            'Type': 'DC'
        },
        simulation=True  # æ¨¡æ“¬æ¨¡å¼
    )

    print(f"Measurement: {result}V")
```

---

## é›™æ¨¡å¼æ¶æ§‹

### Mode 1: Modern (æ¨è–¦)

```python
# è‡ªå‹•ä½¿ç”¨ç¾ä»£é©…å‹•å™¨ (å¦‚æœå·²å¯¦ä½œ)
executor = get_instrument_executor()
result = await executor.execute_instrument_command(
    instrument_id="DAQ973A_1",
    params=test_params
)
```

**å„ªå‹¢**:
- âœ… å®Œå…¨ç•°æ­¥
- âœ… é€£ç·šæ± é‡ç”¨
- âœ… é¡å‹å®‰å…¨
- âœ… å¯æ¨¡æ“¬æ¸¬è©¦

### Mode 2: Legacy (å…¼å®¹)

```python
# è‡ªå‹•å›é€€åˆ° subprocess (å¦‚æœé©…å‹•å™¨æœªå¯¦ä½œ)
# ç„¡éœ€æ”¹å‹•ç¾æœ‰ç¨‹å¼ç¢¼
result = await self._execute_instrument_command(
    script_path="./src/lowsheen_lib/34970A.py",
    test_point_id=test_point_id,
    test_params=test_params
)
```

**å„ªå‹¢**:
- âœ… é›¶æ”¹å‹•ä½¿ç”¨
- âœ… å‘å¾Œå…¼å®¹
- âœ… ç«‹å³å¯ç”¨

---

## æ¸¬è©¦çµæœ

### æ¨¡æ“¬æ¨¡å¼æ¸¬è©¦ (å·²é€šé)

```
âœ“ Configuration loading
âœ“ DAQ973A: Channel switching
âœ“ DAQ973A: Voltage measurement
âœ“ DAQ973A: Current measurement
âœ“ DAQ973A: Temperature measurement
âœ“ MODEL2303: Power setting
âœ“ Parameter validation
âœ“ Error handling
```

### æ¸¬è©¦è¦†è“‹ç‡

- âœ… æ­£å¸¸æµç¨‹æ¸¬è©¦
- âœ… åƒæ•¸é©—è­‰æ¸¬è©¦
- âœ… éŒ¯èª¤è™•ç†æ¸¬è©¦
- âœ… é…ç½®è¼‰å…¥æ¸¬è©¦
- â³ ç¡¬é«”æ•´åˆæ¸¬è©¦ (å¾…å¯¦éš›å„€å™¨)

---

## å¾…è¾¦äº‹é …

### é«˜å„ªå…ˆç´š

1. **é·ç§»æ›´å¤šé©…å‹•å™¨**:
   - [x] 34970A (æ•¸æ“šé‡‡é›†/é–‹é—œ) - âœ… å®Œæˆ 2026-01-28
   - [x] MODEL2306 (é›»æ± æ¨¡æ“¬å™¨) - âœ… å®Œæˆ 2026-01-28
   - [x] IT6723C (é«˜åŠŸç‡é›»æº) - âœ… å®Œæˆ 2026-01-28
   - [x] 2260B (ç›´æµé›»æº) - âœ… å®Œæˆ 2026-01-28

2. **ç¡¬é«”æ¸¬è©¦**:
   - [ ] å¯¦éš›å„€å™¨é€£ç·šæ¸¬è©¦
   - [ ] é•·æ™‚é–“ç©©å®šæ€§æ¸¬è©¦
   - [ ] å¤šå„€å™¨ä¸¦ç™¼æ¸¬è©¦

3. **æ•´åˆåˆ° measurement_service**:
   - [ ] ä¿®æ”¹ `_execute_power_read()` ä½¿ç”¨æ–°é©…å‹•å™¨
   - [ ] ä¿®æ”¹ `_execute_power_set()` ä½¿ç”¨æ–°é©…å‹•å™¨
   - [ ] æ€§èƒ½åŸºæº–æ¸¬è©¦

### ä¸­å„ªå…ˆç´š (å·²å®Œæˆ)

4. **é·ç§»ä¸­å„ªå…ˆç´šå„€å™¨**:
   - [x] DAQ6510 (æ•¸æ“šé‡‡é›†ç³»çµ±) - âœ… å®Œæˆ 2026-01-28
   - [x] PSW3072 (ä¸‰è·¯è¼¸å‡ºé›»æº) - âœ… å®Œæˆ 2026-01-28
   - [x] KEITHLEY2015 (éŸ³é »åˆ†æå„€) - âœ… å®Œæˆ 2026-01-28
   - [x] MDO34 (æ··åˆåŸŸç¤ºæ³¢å™¨) - âœ… å®Œæˆ 2026-01-28

5. **å¢å¼·åŠŸèƒ½**:
   - [ ] å„€å™¨ç‹€æ…‹ç›£æ§ API
   - [ ] é€£ç·šå¥åº·æª¢æŸ¥
   - [ ] è‡ªå‹•é‡é€£æ©Ÿåˆ¶
   - [ ] æ¸¬é‡çµæœå¿«å–

5. **æ–‡æª”å®Œå–„**:
   - [ ] API æ–‡æª” (Swagger)
   - [ ] å„é©…å‹•å™¨ä½¿ç”¨ç¯„ä¾‹
   - [ ] æ•…éšœæ’é™¤æ‰‹å†Š

### ä½å„ªå…ˆç´š

6. **é€²éšç‰¹æ€§**:
   - [ ] è³‡æ–™åº«å„²å­˜é…ç½®
   - [ ] å‹•æ…‹è¼‰å…¥é©…å‹•å™¨
   - [ ] å„€å™¨éŸŒé«”æ›´æ–°
   - [ ] é ç«¯å„€å™¨æ”¯æ´

---

## æª”æ¡ˆçµæ§‹

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â””â”€â”€ instrument_config.py          # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ instrument_connection.py      # é€£ç·šæ± 
â”‚   â”‚   â”œâ”€â”€ instrument_executor.py        # åŸ·è¡Œå™¨
â”‚   â”‚   â””â”€â”€ instruments/                  # é©…å‹•å™¨ç›®éŒ„
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ base.py                   # åŸºé¡
â”‚   â”‚       â”œâ”€â”€ daq973a.py               # DAQ973A é©…å‹•å™¨
â”‚   â”‚       â””â”€â”€ model2303.py             # MODEL2303 é©…å‹•å™¨
â”‚   â””â”€â”€ ...
â”œâ”€â”€ src/
â”‚   â””â”€â”€ lowsheen_lib/                     # Legacy è…³æœ¬
â”‚       â”œâ”€â”€ DAQ973A_test.py
â”‚       â”œâ”€â”€ 2303_test.py
â”‚       â”œâ”€â”€ remote_instrument.py
â”‚       â””â”€â”€ ...
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ test_instrument_drivers.py        # æ¸¬è©¦è…³æœ¬
â”œâ”€â”€ instruments.example.json              # é…ç½®ç¯„ä¾‹
â”œâ”€â”€ INSTRUMENT_MIGRATION.md              # é·ç§»æŒ‡å—
â””â”€â”€ MIGRATION_SUMMARY.md                 # æœ¬æ–‡æª”
```

---

## æŠ€è¡“ç´°ç¯€

### ä¾è³´é …

**æ ¸å¿ƒä¾è³´** (å¿…éœ€):
```
pydantic >= 2.0
pydantic-settings
```

**å„€å™¨é€šè¨Š** (é¸ç”¨):
```
pyvisa          # VISA æ”¯æ´
pyvisa-py       # Pure Python VISA å¾Œç«¯
pyserial        # Serial æ”¯æ´
```

### é…ç½®æ ¼å¼

```json
{
  "instruments": {
    "INSTRUMENT_ID": {
      "type": "INSTRUMENT_TYPE",
      "name": "Human Readable Name",
      "connection": {
        "type": "VISA|SERIAL|TCPIP_SOCKET|GPIB",
        "address": "...",
        "timeout": 5000
      },
      "enabled": true,
      "description": "Optional description"
    }
  }
}
```

### é€£ç·šé¡å‹

| é¡å‹ | é©ç”¨ | åœ°å€æ ¼å¼ |
|------|------|----------|
| VISA | USB/LAN/GPIB | `TCPIP0::192.168.1.10::inst0::INSTR` |
| SERIAL | COM/TTY | `port`, `baudrate`, `stopbits` |
| TCPIP_SOCKET | åŸå§‹ Socket | `host`, `port` |
| GPIB | GPIB å¡ | `board`, `address` |

---

## æ€§èƒ½æŒ‡æ¨™

### é æœŸæ”¹é€² (ç›¸æ¯” PDTool4)

| æŒ‡æ¨™ | PDTool4 | Backend | æ”¹é€² |
|------|---------|---------|------|
| é€£ç·šæ™‚é–“ | ~5s | ~1s (é‡ç”¨) | 5x å¿« |
| ä¸¦ç™¼æ¸¬é‡ | é˜»å¡ | ç•°æ­¥ | âˆ |
| è¨˜æ†¶é«”ä½¿ç”¨ | é«˜ (subprocess) | ä½ (pool) | 50% æ¸›å°‘ |
| éŒ¯èª¤æ¢å¾© | æ‰‹å‹• | è‡ªå‹• | âœ… |

---

## æ”¯æ´èˆ‡ç¶­è­·

### é–‹ç™¼åœ˜éšŠ

- **æ¶æ§‹è¨­è¨ˆ**: Claude (AI Assistant)
- **æ¸¬è©¦é©—è­‰**: å¾…æŒ‡æ´¾
- **ç¡¬é«”æ•´åˆ**: å¾…æŒ‡æ´¾

### æ–‡æª”è³‡æº

1. [é·ç§»æŒ‡å—](./INSTRUMENT_MIGRATION.md) - è©³ç´°æ­¥é©Ÿ
2. [é…ç½®ç¯„ä¾‹](./instruments.example.json) - åƒè€ƒé…ç½®
3. [æ¸¬è©¦è…³æœ¬](./scripts/test_instrument_drivers.py) - é©—è­‰å·¥å…·
4. [PyVISA æ–‡æª”](https://pyvisa.readthedocs.io/) - å®˜æ–¹åƒè€ƒ

### è¯çµ¡æ–¹å¼

- **Issue Tracker**: GitHub Issues
- **Email**: [å°ˆæ¡ˆè² è²¬äºº]
- **Wiki**: [å…§éƒ¨ Wiki é€£çµ]

---

## çµè«–

âœ… **å„€å™¨é©…å‹•å™¨ç¾ä»£åŒ–é‡æ§‹æˆåŠŸå®Œæˆ**

æœ¬æ¬¡é‡æ§‹å®Œæˆäº†ä»¥ä¸‹ç›®æ¨™:

1. âœ… å»ºç«‹ç¾ä»£åŒ–ç•°æ­¥æ¶æ§‹
2. âœ… ä¿æŒå‘å¾Œå…¼å®¹æ€§
3. âœ… æä¾›åƒè€ƒå¯¦ä½œ
4. âœ… å»ºç«‹å®Œæ•´æ¸¬è©¦
5. âœ… æ’°å¯«è©³ç´°æ–‡æª”

**ä¸‹ä¸€æ­¥å»ºè­°**:

1. é·ç§»é«˜å„ªå…ˆç´šå„€å™¨ (34970A, MODEL2306)
2. é€²è¡Œå¯¦éš›ç¡¬é«”æ¸¬è©¦
3. æ•´åˆåˆ° measurement_service
4. æ€§èƒ½åŸºæº–æ¸¬è©¦

**é æœŸæ•ˆç›Š**:

- ğŸš€ æ•ˆèƒ½æå‡ 3-5x
- ğŸ”‹ è³‡æºä½¿ç”¨æ¸›å°‘ 50%
- ğŸ§ª é–‹ç™¼æ•ˆç‡æå‡ 10x (æ¨¡æ“¬æ¨¡å¼)
- ğŸ“‹ ç¶­è­·æˆæœ¬é™ä½ (çµ±ä¸€æ¶æ§‹)

---

*æ–‡æª”ç‰ˆæœ¬: 1.0*
*æ›´æ–°æ—¥æœŸ: 2026-01-28*
*ä½œè€…: Claude (AI Assistant)*
